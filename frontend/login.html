<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sign In - Petit Séminaire Saint Léon Kabgayi</title>
  <link rel="stylesheet" href="styles/main.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body class="dark">
  <div class="login-container">
    <img src="images/logo.PNG" alt="Petit Séminaire Saint Léon Kabgayi Logo" style="display:block; margin: 0 auto 20px auto; width: 50px; pointer-events: none; user-select: none;">
    <h2>Sign In</h2>
    <form id="login-form">
      <div class="form-group">
        <label for="email">Email</label>
        <input type="email" id="email" name="email" required>
      </div>
      <div class="form-group">
        <label for="password">Password</label>
        <div class="input-wrapper">
          <input type="password" id="password" name="password" required>
          <button type="button" class="password-toggle" onclick="togglePassword('password')"><i class="fas fa-eye"></i></button>
        </div>
      </div>
      <div style="text-align:right; margin-bottom:8px;">
        <a href="#" id="forgot-password-link" style="color:#00f7ff; font-size:0.98em;">Forgot Password?</a>
      </div>
      <button type="submit" class="btn btn-primary" id="login-btn">Sign In</button>
      <div style="text-align:center; margin-top:10px;">
        <a class="btn-signup" href="signup.html"><i class="fas fa-user-plus"></i> Don't have an account? Sign Up</a>
      </div>
    </form>
    <form id="forgot-password-form" style="display:none; margin-top:20px;">
      <div class="form-group">
        <label for="forgot-email">Enter your email to reset password</label>
        <input type="email" id="forgot-email" name="forgot-email" required>
      </div>
      <button type="submit" class="btn btn-primary">Send Reset Code</button>
      <div style="text-align:center; margin-top:10px;">
        <a href="#" id="back-to-login" style="color:#00f7ff; font-size:0.98em;">Back to Login</a>
      </div>
    </form>
    <form id="reset-password-form" style="display:none; margin-top:20px;">
      <div class="form-group">
        <label for="reset-code">Enter the code sent to your email</label>
        <input type="text" id="reset-code" name="reset-code" maxlength="6" required>
      </div>
      <div class="form-group">
        <label for="reset-new-password">New Password</label>
        <input type="password" id="reset-new-password" name="reset-new-password" required>
      </div>
      <button type="submit" class="btn btn-primary">Reset Password</button>
      <div style="text-align:center; margin-top:10px;">
        <a href="#" id="reset-back-to-login" style="color:#00f7ff; font-size:0.98em;">Back to Login</a>
      </div>
    </form>
    <div id="login-message" class="login-message" role="alert" aria-live="polite"></div>
  </div>
  <script>
    function togglePassword(id) {
      const input = document.getElementById(id);
      input.type = input.type === 'password' ? 'text' : 'password';
    }
    let resetEmail = '';
    document.getElementById('forgot-password-link').onclick = function(e) {
      e.preventDefault();
      document.getElementById('login-form').style.display = 'none';
      document.getElementById('forgot-password-form').style.display = 'block';
      document.getElementById('reset-password-form').style.display = 'none';
      document.getElementById('login-message').innerHTML = '';
    };
    document.getElementById('back-to-login').onclick = function(e) {
      e.preventDefault();
      document.getElementById('forgot-password-form').style.display = 'none';
      document.getElementById('reset-password-form').style.display = 'none';
      document.getElementById('login-form').style.display = 'block';
      document.getElementById('login-message').innerHTML = '';
    };
    document.getElementById('reset-back-to-login').onclick = function(e) {
      e.preventDefault();
      document.getElementById('reset-password-form').style.display = 'none';
      document.getElementById('forgot-password-form').style.display = 'none';
      document.getElementById('login-form').style.display = 'block';
      document.getElementById('login-message').innerHTML = '';
    };
    document.getElementById('forgot-password-form').addEventListener('submit', async function(e) {
      e.preventDefault();
      const email = document.getElementById('forgot-email').value.trim();
      const messageDiv = document.getElementById('login-message');
      if (!email) {
        messageDiv.innerHTML = '<span style="color:red">Please enter your email.</span>';
        return;
      }
      try {
        const res = await fetch('/api/auth/forgot-password', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email })
        });
        const data = await res.json();
        messageDiv.innerHTML = `<span style="color:#00f7ff">${data.message}</span>`;
        if (res.ok) {
          resetEmail = email;
          document.getElementById('forgot-password-form').style.display = 'none';
          document.getElementById('reset-password-form').style.display = 'block';
        }
      } catch (err) {
        messageDiv.innerHTML = '<span style="color:red">Error sending reset code. Try again later.</span>';
      }
    });
    document.getElementById('reset-password-form').addEventListener('submit', async function(e) {
      e.preventDefault();
      const code = document.getElementById('reset-code').value.trim();
      const newPassword = document.getElementById('reset-new-password').value;
      const messageDiv = document.getElementById('login-message');
      if (!resetEmail || !code || !newPassword) {
        messageDiv.innerHTML = '<span style="color:red">Please fill in all fields.</span>';
        return;
      }
      if (newPassword.length < 6) {
        messageDiv.innerHTML = '<span style="color:red">Password must be at least 6 characters.</span>';
        return;
      }
      try {
        const res = await fetch('/api/auth/reset-password', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email: resetEmail, code, newPassword })
        });
        const data = await res.json();
        if (res.ok) {
          messageDiv.innerHTML = `<span style="color:#00f7ff">${data.message} You can now log in.</span>`;
          document.getElementById('reset-password-form').style.display = 'none';
          document.getElementById('login-form').style.display = 'block';
        } else {
          messageDiv.innerHTML = `<span style="color:red">${data.message}</span>`;
        }
      } catch (err) {
        messageDiv.innerHTML = '<span style="color:red">Error resetting password. Try again later.</span>';
      }
    });
    document.getElementById('login-form').addEventListener('submit', function(e) {
      e.preventDefault();
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;
      const messageDiv = document.getElementById('login-message');
      const loginBtn = document.getElementById('login-btn');
      // Basic validation
      if (!email || !password) {
        messageDiv.innerHTML = '<span style="color:red">Please enter both email and password.</span>';
        return;
      }
      if (password.length < 6) {
        messageDiv.innerHTML = '<span style="color:red">Password must be at least 6 characters.</span>';
        return;
      }
      loginBtn.disabled = true;
      loginBtn.textContent = 'Signing In...';
      messageDiv.innerHTML = '';
      // Admin login
      setTimeout(function() { // Simulate async
        if(email === 'joyeuxpierreishimwe@gmail.com' && password === 'admin123') {
          window.location.href = 'admin-dashboard.html';
          return;
        }
        // Teacher login (for demo: email contains 'teacher' and password is not empty)
        if(email.includes('teacher') && password.length > 0) {
          window.location.href = 'teacher-dashboard.html';
          return;
        }
        // Student login (for demo: any other email and password is not empty)
        if(password.length > 0) {
          window.location.href = 'student.html';
          return;
        }
        messageDiv.innerHTML = '<span style="color:red">Invalid credentials or not yet approved. Please contact the school administration.</span>';
        loginBtn.disabled = false;
        loginBtn.textContent = 'Sign In';
      }, 600);
    });
  </script>
  <style>
    .login-container { max-width: 400px; margin: 60px auto; background: rgba(30,30,40,0.95); padding: 32px 28px; border-radius: 18px; box-shadow: 0 8px 32px #0008; }
    .login-container h2 { text-align: center; margin-bottom: 24px; color: #00f7ff; }
    .form-group { margin-bottom: 18px; }
    .form-group label { display: block; margin-bottom: 6px; color: #fff; }
    .form-group input { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #444; background: #222; color: #fff; }
    .input-wrapper { position: relative; }
    .password-toggle { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; color: #00f7ff; cursor: pointer; }
    .btn.btn-primary { width: 100%; padding: 12px; font-size: 1.1rem; margin-top: 10px; }
    .login-message { margin-top: 18px; text-align: center; font-size: 1.05rem; }
  </style>
</body>
</html>

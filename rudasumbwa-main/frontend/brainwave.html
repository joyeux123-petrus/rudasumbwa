<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>BrainWave 10K - Neural Interface</title>
  <link rel="stylesheet" href="styles/brainwave.css">
</head>
<body>
  <!-- Welcome Screen -->
  <div id="intro-screen">
    <h1 id="glow-title">Welcome to BrainWave 10K</h1>
    <p id="interaction-message">Initializing Neural Interface...</p>
    <button id="start-btn">Begin</button>
  </div>

  <!-- Grade Selection -->
  <div id="grade-selection" class="grade-selection">
    <h2>Select Your Grade Level</h2>
    <button id="grade-10-12-btn">Grade 10-12</button>
    <button id="grade-8-9-btn">Grade 8-9</button>
    <button id="grade-7-btn">Grade 7</button>
    <button id="math-geeks-btn">Math Geeks</button>
  </div>

  <!-- Game Interface -->
  <div id="game-container" class="game-container">
    <div id="question-text" class="question-text"></div>
    <div id="error-message" style="color: #ff0000; display: none; margin: 10px 0;"></div>
    <div id="answer-buttons" class="answer-buttons"></div>
    <button id="wakanda-btn" class="interactive-btn" style="margin-top: 20px;">WAKANDA FOREVER</button>
    <div class="score-timer">
      <div id="score" class="score">Score: 0</div>
      <div id="correct" class="correct">Correct: 0</div>
      <div id="incorrect" class="incorrect">Incorrect: 0</div>
      <div id="timer" class="timer">Time: 0</div>
    </div>
  </div>

  <!-- Wakanda Results Modal -->
  <div id="wakanda-modal" class="wakanda-modal">
    <div class="modal-content">
      <h2>Wakanda Forever!</h2>
      <p>Your Score: <span id="wakanda-score">0</span></p>
      <p>Correct Answers: <span id="wakanda-correct">0</span></p>
      <p>Time Taken: <span id="wakanda-time">0</span>s</p>
      <button id="close-wakanda" class="interactive-btn">Close</button>
    </div>
  </div>

  <script>
    // Typing effect
    const msg = "Activate your mind. Outsmart the system. Prove you're the future";
    let index = 0;
    const interactionText = document.getElementById('interaction-message');

    function typeEffect() {
      if (index < msg.length) {
        interactionText.textContent += msg.charAt(index);
        index++;
        setTimeout(typeEffect, 50);
      }
    }

    setTimeout(() => {
      interactionText.textContent = '';
      typeEffect();
    }, 1500);

    // Handle begin button click
    document.getElementById('start-btn').addEventListener('click', () => {
      document.getElementById('intro-screen').style.transition = 'opacity 1s ease';
      document.getElementById('intro-screen').style.opacity = '0';
      
      setTimeout(() => {
        document.getElementById('intro-screen').style.display = 'none';
        document.getElementById('grade-selection').style.display = 'flex';
      }, 1000);
    });

    // Game state variables
    let currentQuestionIndex = 0;
    let score = 0;
    let correctAnswers = 0;
    let incorrectAnswers = 0;
    let timeElapsed = 0;
    let timerInterval;
    let currentQuestions = [];
    let currentLevel = '';

    // API endpoints
    const API_ENDPOINTS = {
      'grade-7': 'https://opentdb.com/api.php?amount=50&category=17&difficulty=easy&type=multiple&encode=base64',
      'grade-8-9': 'https://opentdb.com/api.php?amount=50&category=17&difficulty=medium&type=multiple&encode=base64',
      'grade-10-12': 'https://opentdb.com/api.php?amount=50&category=17&difficulty=hard&type=multiple&encode=base64',
      'math-geeks': 'https://api.difficultmathquestions.com/get', // New API for difficult questions
      'math-fallback1': 'https://api.mathjs.org/v4/?expr=2%2B3*sqrt(4)', // Example math.js API
      'math-fallback2': 'https://mathqa-api.example.com/questions' // Example alternative
    };

    // No local questions - only API-based
    const FALLBACK_MATH_QUESTIONS = [];

    // Helper to format questions consistently
    function formatMathQuestion(question, correctAnswer) {
      const incorrectAnswers = [
        (parseFloat(correctAnswer) + 1).toString(),
        (parseFloat(correctAnswer) - 1).toString(),
        (parseFloat(correctAnswer) * 2).toString()
      ];
      
      return {
        question: question,
        answers: [
          correctAnswer.toString(),
          ...incorrectAnswers
        ].sort(() => Math.random() - 0.5),
        correct: 0
      };
    }

    // Decode base64 strings from OpenTrivia
    function decodeBase64(str) {
      return decodeURIComponent(escape(atob(str)));
    }

    // Fetch questions from API
    async function fetchQuestions(level) {
      try {
        if (level === 'math-geeks') {
          // For Math Geeks, we'll fetch one question at a time
          return null;
        }
        
        const response = await fetch(API_ENDPOINTS[level]);
        const data = await response.json();
        
        return data.results.map(q => ({
          question: decodeBase64(q.question),
          answers: [
            decodeBase64(q.correct_answer),
            ...q.incorrect_answers.map(a => decodeBase64(a))
          ].sort(() => Math.random() - 0.5), // Shuffle answers
          correct: 0 // Correct answer is always first after shuffle
        }));
      } catch (error) {
        console.error('Error fetching questions:', error);
        return null;
      }
    }

    // Math question generator with math.js
    async function fetchMathQuestion() {
      // Question templates
      const questionTemplates = [
        {
          template: "What is {a} + {b}?",
          fn: (a, b) => a + b
        },
        {
          template: "Solve for x: {a}x + {b} = {c}",
          fn: (a, b, c) => (c - b) / a
        },
        {
          template: "What is the square root of {a}?",
          fn: (a) => Math.sqrt(a)
        },
        {
          template: "What is {a} Ã— {b}?",
          fn: (a, b) => a * b
        }
      ];

      // Generate random parameters
      const a = Math.floor(Math.random() * 10) + 1;
      const b = Math.floor(Math.random() * 10) + 1;
      const c = a * 2 + b; // Ensure solvable equation
      
      // Select random template
      const template = questionTemplates[
        Math.floor(Math.random() * questionTemplates.length)
      ];
      
      // Generate question and answer
      const question = template.template
        .replace('{a}', a)
        .replace('{b}', b)
        .replace('{c}', c);
      
      const correctAnswer = template.fn(a, b, c).toString();
      
      return formatMathQuestion(question, correctAnswer);
    }

    // Grade selection handlers
    document.getElementById('grade-10-12-btn').addEventListener('click', async () => {
      await startGame('grade-10-12');
    });

    document.getElementById('grade-8-9-btn').addEventListener('click', async () => {
      await startGame('grade-8-9');
    });

    document.getElementById('grade-7-btn').addEventListener('click', async () => {
      await startGame('grade-7');
    });

    document.getElementById('math-geeks-btn').addEventListener('click', async () => {
      await startGame('math-geeks');
    });

    // Start game function
    async function startGame(level) {
      document.getElementById('grade-selection').style.display = 'none';
      document.getElementById('game-container').style.display = 'flex';
      
      // Show loading message
      document.getElementById('question-text').textContent = 'Loading questions...';
      document.getElementById('answer-buttons').innerHTML = '';
      
      // Start timer
      timerInterval = setInterval(() => {
        timeElapsed++;
        document.getElementById('timer').textContent = `Time: ${timeElapsed}`;
      }, 1000);

      currentLevel = level;
      currentQuestionIndex = 0;
      
      if (level === 'math-geeks') {
        // For Math Geeks, we'll fetch questions one at a time
        await loadQuestion(level);
      } else {
        // For other levels, fetch all questions at once
        currentQuestions = await fetchQuestions(level);
        if (!currentQuestions || currentQuestions.length === 0) {
          showError();
          return;
        }
        await loadQuestion(level);
      }
    }

    function showError() {
      const errorDiv = document.getElementById('error-message');
      errorDiv.textContent = 'Wakanda boys are working behind the scenes to ensure you get the most relevant questions. Please hold on while we optimize your experience';
      errorDiv.style.display = 'block';
      
      const button = document.createElement('button');
      button.textContent = 'Return to Menu';
      button.addEventListener('click', resetGame);
      document.getElementById('answer-buttons').innerHTML = '';
      document.getElementById('answer-buttons').appendChild(button);
    }

    // Add click handler for WAKANDA FOREVER button
    document.getElementById('wakanda-btn').addEventListener('click', endGame);

    // Load question function
    async function loadQuestion(level) {
      let currentQuestion;
      
      if (level === 'math-geeks') {
        currentQuestion = await fetchMathQuestion();
        if (!currentQuestion) {
          showError();
          return;
        }
      } else {
        currentQuestion = currentQuestions[currentQuestionIndex];
      }
      
      document.getElementById('question-text').textContent = currentQuestion.question;
      
      const answerButtons = document.getElementById('answer-buttons');
      answerButtons.innerHTML = '';
      
      currentQuestion.answers.forEach((answer, index) => {
        const button = document.createElement('button');
        button.textContent = answer;
        button.addEventListener('click', () => selectAnswer(index, level));
        answerButtons.appendChild(button);
      });
    }

    // Select answer function
    async function selectAnswer(answerIndex, level) {
      let currentQuestion;
      
      if (level === 'math-geeks') {
        currentQuestion = currentQuestions[currentQuestionIndex] || await fetchMathQuestion();
      } else {
        currentQuestion = currentQuestions[currentQuestionIndex];
      }
      
      // Check if answer is correct (correct answer is always index 0 after shuffle)
      if (answerIndex === 0) {
        score += 10;
        correctAnswers++;
      } else {
        incorrectAnswers++;
      }
      
      // Update score display
      document.getElementById('score').textContent = `Score: ${score}`;
      document.getElementById('correct').textContent = `Correct: ${correctAnswers}`;
      document.getElementById('incorrect').textContent = `Incorrect: ${incorrectAnswers}`;
      
      // Move to next question or end game
      currentQuestionIndex++;
      if (level === 'math-geeks' || currentQuestionIndex < currentQuestions.length) {
        await loadQuestion(level);
      } else {
        endGame();
      }
    }

    // End game function
    function endGame() {
      clearInterval(timerInterval);
      
      // Show results modal
      document.getElementById('wakanda-score').textContent = score;
      document.getElementById('wakanda-correct').textContent = correctAnswers;
      document.getElementById('wakanda-time').textContent = timeElapsed;
      document.getElementById('wakanda-modal').style.display = 'flex';
      
      // Close modal handler
      document.getElementById('close-wakanda').addEventListener('click', () => {
        document.getElementById('wakanda-modal').style.display = 'none';
        resetGame();
      });
    }

    // Reset game function
    function resetGame() {
      currentQuestionIndex = 0;
      score = 0;
      correctAnswers = 0;
      incorrectAnswers = 0;
      timeElapsed = 0;
      
      document.getElementById('game-container').style.display = 'none';
      document.getElementById('grade-selection').style.display = 'flex';
    }
  </script>
</body>
</html>
